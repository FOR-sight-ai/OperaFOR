<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <title>LLM Only Demo</title>
    <style>
        body {
            font-family: sans-serif;
            margin: 2em;
            background: #f9f9f9;
        }

        textarea,
        input,
        button {
            width: 100%;
            padding: 1em;
            margin-bottom: 1em;
            font-family: monospace;
            font-size: 1em;
        }

        pre {
            background: #333;
            color: #eee;
            padding: 1em;
            border-radius: 5px;
            overflow-x: auto;
            white-space: pre-wrap;
        }

        #configPanel {
            display: none;
            margin-bottom: 1em;
        }

        .toggle-button {
            background-color: #007BFF;
            color: white;
            border: none;
            padding: 0.5em 1em;
            cursor: pointer;
            font-size: 1em;
            margin-bottom: 1em;
        }
    </style>
</head>

<body>
    <h1>LLM Only Demo</h1>
    <button class="toggle-button" onclick="toggleConfig()">Show Configuration</button>
    <div id="configPanel">
        <h3>Configuration (JSON)</h3>
        <textarea id="config" rows="8"></textarea>
    </div>
    <h3>User Request</h3>
    <textarea id="userInput" rows="4">What is 25 + 325 ?</textarea>
    <button onclick="run()">Run</button>
    <h3>Response</h3>
    <pre id="output">Waiting...</pre>
    <script>
        const defaultConfig = `{
  "llm": {
    "endpoint": "https://openrouter.ai/api/v1/chat/completions",
    "model": "deepseek/deepseek-chat-v3-0324:free",
    "apiKey": "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"
  }
}`;
        // Gestion de la configuration via config.json côté serveur
        async function loadConfig() {
            try {
                const res = await fetch('/config.json');
                if (!res.ok) throw new Error('Erreur de lecture config.json');
                return await res.json();
            } catch (e) {
                // Si le backend n'est pas prêt ou autre erreur
                return JSON.parse(defaultConfig);
            }
        }
        async function saveConfig(configObj) {
            try {
                await fetch('/config.json', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(configObj)
                });
            } catch (e) {
                // Silencieux, mais on pourrait afficher une erreur
            }
        }
        window.onload = async function () {
            const configObj = await loadConfig();
            document.getElementById('config').value = JSON.stringify(configObj, null, 2);
        };
        document.getElementById('config').addEventListener('change', async function () {
            try {
                const configObj = JSON.parse(this.value);
                await saveConfig(configObj);
            } catch (e) {
                // Ignore erreurs de parsing
            }
        });
        function toggleConfig() {
            const panel = document.getElementById('configPanel');
            const button = document.querySelector('.toggle-button');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                button.textContent = 'Hide Configuration';
            } else {
                panel.style.display = 'none';
                button.textContent = 'Show Configuration';
            }
        }
        async function run() {
            const configText = document.getElementById('config').value;
            let config;
            try {
                config = JSON.parse(configText);
            } catch (e) {
                document.getElementById('output').textContent = 'Erreur: configuration JSON invalide';
                return;
            }
            await saveConfig(config); // Sauvegarde à chaque exécution
            const userInput = document.getElementById('userInput').value;
            const output = document.getElementById('output');
            output.textContent = "Calling the agent...\n";

            const llm = config.llm || {};
            const payload = {
                model: llm.model,
                base_url: llm.base_url || llm.endpoint, // compatibility
                api_key: llm.apiKey,
                servers: config.servers || [
                    {
                        type: "http",
                        config: { url: "http://localhost:9000/mcp" }
                    }
                ],
                prompt: userInput
            };
            try {
                const res = await fetch("/agent", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });
                if (!res.body) {
                    output.textContent = "Erreur: Pas de flux de réponse.";
                    return;
                }
                const reader = res.body.getReader();
                output.textContent = "";
                const decoder = new TextDecoder();
                let done = false;
                while (!done) {
                    const { value, done: doneReading } = await reader.read();
                    done = doneReading;
                    if (value) {
                        output.textContent += decoder.decode(value, { stream: !done });
                        output.scrollTop = output.scrollHeight;
                    }
                }
            } catch (e) {
                output.textContent = "Erreur: " + e;
            }
        }
    </script>
</body>

</html>
